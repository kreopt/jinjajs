!function(){function t(){this.nest=[],this.compiled=[],this.childBlocks=0,this.parentBlocks=0,this.isSilent=!1}function e(t){return t.replace(f,"")}function n(t){return t.replace(j,"")}function i(t,e,n){return new Promise(function(i){function r(){s?n(s[0],s.index,t).then(function(n){"number"==typeof n&&(e.lastIndex=n),s=e.exec(t),r()}):i()}e=new RegExp(e.source,"g"+(e.ignoreCase?"i":"")+(e.multiline?"m":""));var s=e.exec(t);r()})}var r=/'(\\.|[^'])*'|"(\\.|[^"'"])*"/g,s=/([$_a-z][$\w]*)|([+-]?\d+(\.\d+)?)/g,a=/^[+-]?\d+(\.\d+)?$/,o=/\[[@#~](,[@#~])*\]|\[\]|\{([@i]:[@#~])(,[@i]:[@#~])*\}|\{\}/g,c=/[$_a-z][$\w]*/gi,u=/i(\.i|\[[@#i]\])*/g,l=/(\.i|\[[@#i]\])/g,p=/(===?|!==?|>=?|<=?|&&|\|\||[+\-\*\/%])/g,h=/(^|[^$\w])(and|or|not|is|isnot)([^$\w]|$)/g,f=/^\s+/,j=/\s+$/,g=/\{\{\{|\{\{|\{%|\{#/,m={"{{{":/^('(\\.|[^'])*'|"(\\.|[^"'"])*"|.)+?\}\}\}/,"{{":/^('(\\.|[^'])*'|"(\\.|[^"'"])*"|.)+?\}\}/,"{%":/^('(\\.|[^'])*'|"(\\.|[^"'"])*"|.)+?%\}/,"{#":/^('(\\.|[^'])*'|"(\\.|[^"'"])*"|.)+?#\}/},d={"{%":"directive","{{":"output","{#":"comment"},v={and:"&&",or:"||",not:"!",is:"==",isnot:"!="},k={"true":!0,"false":!1,"null":null};t.prototype.push=function(t){this.isSilent||this.compiled.push(t)},t.prototype.parse=function(t){var e=this;return e.tokenize(t).then(function(){return Promise.resolve(e.compiled)})},t.prototype.tokenize=function(t){var s=this;return new Promise(function(a){var o=0,c=s,u=!1;i(t,g,function(t,i,s){var a=s.slice(i+t.length).match(m[t]);a=a?a[0]:"";var l=a.replace(r,"@");if(!a||~l.indexOf(t))return Promise.resolve(i+1);var p=a.slice(0,0-t.length);if("-"==p.charAt(0))var h=!0;if("-"==p.slice(-1))var f=!0;if(p=p.replace(/^-|-$/g,"").trim(),c.rawMode&&t+p!="{%endraw")return Promise.resolve(i+1);var j=s.slice(o,i);if(o=i+t.length+a.length,u&&(j=e(j)),h&&(j=n(j)),f&&(u=!0),"{{{"==t)t="{{",p+="|safe";else if("{#"==t)return Promise.resolve(o);return c.textHandler(j),c.tokenHandler(t,p)}).then(function(){var n=t.slice(o);u&&(n=e(n)),s.textHandler(n),a()})})},t.prototype.textHandler=function(t){t&&this.push("write("+JSON.stringify(t)+");")},t.prototype.tokenHandler=function(t,e){var n=d[t];if("directive"==n)return this.compileTag(e);if("output"==n){var i=this.extractEnt(e,r,"@");i.src=i.src.replace(/\|\|/g,"~").split("|"),i.src=i.src.map(function(t){return t.split("~").join("||")});var s=this.injectEnt(i,"@");if(s.length>1){var a=s.slice(1).map(this.parseFilter.bind(this));this.push("filter("+this.parseExpr(s[0])+","+a.join(",")+");")}else this.push("filter("+this.parseExpr(s[0])+");");return Promise.resolve()}return Promise.resolve()},t.prototype.compileTag=function(t){var e=t.split(" ")[0],n=jinja.tag_handlers[e];if(!n)throw new Error("Invalid tag: "+t);var i=n.call(this,t.slice(e.length).trim());return void 0==i?Promise.resolve():i},t.prototype.parseFilter=function(t){t=t.trim();var e=t.match(/[:(]/),n=e?e.index:-1;if(0>n)return JSON.stringify([t]);var i=t.slice(0,n),r=":"==t.charAt(n)?t.slice(n+1):t.slice(n+1,-1);return r=this.parseExpr(r,{terms:!0}),"["+JSON.stringify(i)+","+r+"]"},t.prototype.extractEnt=function(t,e,n){var i=[],r="function"==typeof n;return t=t.replace(e,function(t){var e=r?n(t):n;return e?(i.push(t),e):t}),{src:t,subs:i}},t.prototype.injectEnt=function(t,e){var n=t.src,i=t.subs,r=Array.isArray(n),s=r?n:[n],a=new RegExp("["+e+"]","g"),o=0;return s.forEach(function(t,e){s[e]=t.replace(a,function(){return i[o++]})}),r?s:s[0]},t.prototype.replaceComplex=function(t){var e=this.extractEnt(t,/i(\.i|\[[@#i]\])+/g,"v");return e.src=e.src.replace(o,"~"),this.injectEnt(e,"v")},t.prototype.parseExpr=function(t,e){e=e||{};var n=this.extractEnt(t,r,"@");n.src=n.src.replace(h,function(t,e,n,i){return n in v?e+v[n]+i:t});var i=this.extractEnt(n.src,s,function(t){return t in k||a.test(t)?"#":null}),o=this.extractEnt(i.src,c,"i");o.src=o.src.replace(/\s+/g,"");for(var l=o.src;l!=(l=this.replaceComplex(l)););for(;l!=(l=l.replace(/i(\.i|\[[@#i]\])+/,"v")););l=l.replace(/[iv]\[v?\]/g,"x"),l=l.replace(/[@#~v]/g,"i"),l=l.replace(p,"%"),l=l.replace(/!+[i]/g,"i");var f=e.terms?l.split(","):[l];return f.forEach(function(e){for(;e!=(e=e.replace(/\(i(%i)*\)/g,"i")););if(!e.match(/^i(%i)*$/))throw new Error("Invalid expression: "+t)}),o.src=o.src.replace(u,this.parseVar.bind(this)),i.src=this.injectEnt(o,"i"),n.src=this.injectEnt(i,"#"),this.injectEnt(n,"@")},t.prototype.parseVar=function(t){var e=Array.prototype.slice.call(arguments),n=e.pop(),i=e.pop();if("i"==t&&":"==n.charAt(i+1))return'"i"';var r=['"i"'];return t.replace(l,function(t){r.push(".i"==t?'"i"':"[i]"==t?'get("i")':t.slice(1,-1))}),"get("+r.join(",")+")"},t.prototype.escName=function(t){return t.replace(/\W/g,function(t){return"$"+t.charCodeAt(0).toString(16)})},t.prototype.parseQuoted=function(t){"'"==t.charAt(0)&&(t=t.slice(1,-1).replace(/\\.|"/,function(t){return"\\'"==t?"'":"\\"==t.charAt(0)?t:"\\"+t}),t='"'+t+'"');try{return JSON.parse(t)}catch(e){return console.error("could not parse string "+t+"! replacing by empty"),""}},window.jinja={},jinja.tag_handlers={},jinja.filter_handlers={};var y,_=Object.prototype.toString,w=Object.prototype.hasOwnProperty,x=function(t){return null==t?"":"function"==typeof t.toString?t.toString():_.call(t)},E=function(t,e){var n={autoEscape:"html"},i=function(t,e){return Object.keys(e).forEach(function(n){t[n]=e[n]}),t},r=function(){for(var t,e=arguments[0],n=f.length;n--&&(t=f[n][e],"undefined"==typeof t););for(var i=1,r=arguments.length;r>i;i++)null!=t&&(e=arguments[i],t=w.call(t,e)?t[e]:"function"==typeof t._get?t[e]=t._get(e):null);return null==t?null:t},s=function(t,e){f[f.length-1][t]=e},a=function(t){f.push(t||{})},o=function(){f.pop()},c=function(t){j.push(t)},u=function(n){for(var i=1,r=arguments.length;r>i;i++){var s=arguments[i],a=s[0],o=jinja.filter_handlers[a];if(!o)throw new Error("Invalid filter: "+a);s[0]=n,n=o.apply(t,s)}e.autoEscape&&a!=e.autoEscape&&"safe"!=a&&(n=jinja.filter_handlers[e.autoEscape].call(t,n)),j.push(n)},l=function(t,e,n,r){if(null!=t){var s=Array.isArray(t)?t:Object.keys(t),c=s.length,u={loop:{length:c,first:s[0],last:s[c-1]}};a(u);for(var l=0;c>l;l++)i(u.loop,{index:l+1,index0:l}),n(u[e]=s[l]);0==c&&r&&r(),o()}},p=function(t){a(),t(),o()},h=function(){return j.join("")};t=t||{},e=i(n,e||{});var f=[Object.create(t||{})],j=[];return{get:r,set:s,push:a,pop:o,write:c,filter:u,each:l,block:p,render:h}};jinja.make_tag=function(t,e){jinja.tag_handlers[t]="string"==typeof e?jinja.tag_handlers[e]:e},jinja.make_filter=function(t,e){jinja.filter_handlers.name&&console.warn("Filter "+t+" already exists. Overriding."),jinja.filter_handlers[t]=e},jinja.compile=function(e,n){var i=this;return new Promise(function(r){n=n||{};var s=new t;s.readTemplateFile=i.readTemplateFile;var a=[];a.push("function render($) {"),a.push("var get = $.get, set = $.set, push = $.push, pop = $.pop, write = $.write, filter = $.filter, each = $.each, block = $.block;"),s.parse(e).then(function(t){if(a.push.apply(a,t),a.push("return $.render();"),a.push("}"),a=a.join("\n"),n.runtime===!1)var e=new Function("data","options","return ("+a+")(runtime(data, options))");else y=y||(y=E.toString()),e=new Function("data","options","return ("+a+")(("+y+")(data, options))");r({render:e})})})},jinja.render=function(t,e,n){return new Promise(function(i){var r={},s=[];for(var a in e)e[a]instanceof Promise&&(r[a]=s.length,s.push(e[a]));Promise.all(s).then(function(s){for(var a in r)e[a]=s[r[a]];jinja.compile(t).then(function(t){i(t.render(e,n))})}).catch(function(t){console.error(t)})})},jinja.templateFiles={},jinja.template_url="/templates/",jinja.readTemplateFile=function(t){return new Promise(function(e,n){var i=jinja.templateFiles||{},r=i[t];null==r?$.get(jinja.template_url+t,function(n){jinja.templateFiles[t]=n,e(n)}).fail(function(){n("Template file not found: "+t)}):e(r)})},jinja.make_filter("html",function(t){return x(t).split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")}),jinja.make_filter("safe",function(t){return t}),jinja.make_tag("block",function(t){if(this.isParent){++this.parentBlocks;var e="block_"+(this.escName(t)||this.parentBlocks);this.push("block(typeof "+e+' == "function" ? '+e+" : function() {")}else this.hasParent&&(this.isSilent=!1,++this.childBlocks,e="block_"+(this.escName(t)||this.childBlocks),this.push("function "+e+"() {"));this.nest.unshift("block")}),jinja.make_tag("endblock",function(){this.nest.shift(),this.isParent?this.push("});"):this.hasParent&&(this.push("}"),this.isSilent=!0)}),jinja.make_tag("extends",function(t){(t[0].startsWith("'")||t[0].startsWith('"'))&&(t=this.parseQuoted(t));var e=this;return this.readTemplateFile(t).then(function(t){return e.isParent=!0,e.tokenize(t).then(function(){e.isParent=!1,e.hasParent=!0,e.isSilent=!0})}).catch(function(t){console.error(t)})}),jinja.make_tag("for",function(t){var e=t.indexOf(" in "),n=t.slice(0,e).trim(),i=t.slice(e+4).trim();this.push("each("+this.parseExpr(i)+","+JSON.stringify(n)+",function() {"),this.nest.unshift("for")}),jinja.make_tag("endfor",function(){this.nest.shift(),this.push("});")}),jinja.make_tag("if",function(t){this.push("if ("+this.parseExpr(t)+") {"),this.nest.unshift("if")}),jinja.make_tag("else",function(){this.push("for"==this.nest[0]?"}, function() {":"} else {")}),jinja.make_tag("elseif",function(t){this.push("} else if ("+this.parseExpr(t)+") {")}),jinja.make_tag("elif","elseif"),jinja.make_tag("endif",function(){this.nest.shift(),this.push("}")}),jinja.make_tag("include",function(t){(t[0].startsWith("'")||t[0].startsWith('"'))&&(t=this.parseQuoted(t));var e=this;return this.readTemplateFile(t).then(function(t){return e.isInclude=!0,e.tokenize(t).then(function(){e.isInclude=!1})}).catch(function(t){console.error(t)})}),jinja.make_tag("raw",function(){this.rawMode=!0}),jinja.make_tag("endraw",function(){this.rawMode=!1}),jinja.make_tag("set",function(t){var e=t.indexOf("="),n=t.slice(0,e).trim(),i=t.slice(e+1).trim();this.push("set("+JSON.stringify(n)+","+this.parseExpr(i)+");")}),jinja.make_tag("assign","set"),jinja.make_tag("static",function(t){t=t.trim(),this.push('write("'+Fat.config.static_url+t.substr(1,t.length-2)+'")')})}();
//# sourceMappingURL=jinja.min.js.map